{{ define "main" }}
<main class="container">
  <h1>{{ .Title }}</h1>
  {{ with .Params.summary }}<p>{{ . }}</p>{{ end }}

  {{/* All project pages under /content/projects, newest first. No pagination. */}}
  {{ $proj := .Pages.ByDate.Reverse }}

  {{/* Build unique category/tag sets for the filter buttons */}}
  {{ $cats := slice }}
  {{ range $proj }}{{ with .Params.categories }}{{ range . }}{{ $cats = $cats | append . }}{{ end }}{{ end }}{{ end }}
  {{ $cats = $cats | uniq | sort }}

  {{ $tags := slice }}
  {{ range $proj }}{{ with .Params.tags }}{{ range . }}{{ $tags = $tags | append . }}{{ end }}{{ end }}{{ end }}
  {{ $tags = $tags | uniq | sort }}

  <div id="filters" style="margin:.5rem 0 1.25rem;">
    <strong>Filter:</strong>
    <button class="fbtn" data-filter="*">All</button>
    {{ range $cats }}<button class="fbtn" data-filter='cat:{{ . }}'>{{ . }}</button>{{ end }}
    {{ range $tags }}<button class="fbtn" data-filter='tag:{{ . }}'>#{{ . }}</button>{{ end }}
  </div>

  <div id="cards" class="grid">
    {{ range $p := $proj }}
      {{ $catStr := delimit (default (slice) $p.Params.categories) " " }}
      {{ $tagStr := delimit (default (slice) $p.Params.tags) " " }}
      <article class="card" data-cats="{{ $catStr }}" data-tags="{{ $tagStr }}">
        <a href="{{ $p.RelPermalink }}">
          {{ with $p.Params.cover }}<img src="{{ . }}" alt="{{ $p.Title }}" loading="lazy"/>{{ end }}
          <h3>{{ $p.Title }}</h3>
          <p>{{ with $p.Params.summary }}{{ . }}{{ else }}{{ $p.Summary }}{{ end }}</p>
          <small>
            {{ range $p.Params.categories }}<span class="chip">{{ . }}</span>{{ end }}
            {{ range $p.Params.tags }}<span class="chip">#{{ . }}</span>{{ end }}
          </small>
        </a>
      </article>
    {{ end }}
  </div>
</main>

<style>
  /* No :root overrides. Let the theme own the palette. */

  /* Layout */
  .grid {
    display:grid;
    gap:1rem;
    grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
  }

  /* Cards – theme-aware with safe fallbacks */
  .card {
    background: var(--entry, var(--card, var(--surface, #fff)));
    color: inherit;
    border: 1px solid var(--border, color-mix(in srgb, currentColor 18%, transparent));
    border-radius: 14px;
    padding: 1rem;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
    border-color: var(--primary, currentColor);
  }
  .card img { width:100%; height:140px; object-fit:cover; border-radius:10px; margin-bottom:.6rem; }
  .card h3 { margin:.25rem 0 .35rem; }
  .card p  { opacity:.85; }
  .chip { margin-right:.35rem; opacity:.8; font-size:.85rem; }

  /* Filter pills – inherit text color so they match the header */
  #filters { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; margin:.5rem 0 1.25rem; }
  #filters strong { margin-right:.25rem; opacity:.7; }

  .fbtn {
    appearance:none;
    background: var(--button-bg, color-mix(in srgb, currentColor 8%, transparent));
    color: inherit;                    /* key: follow theme text */
    border: 1px solid color-mix(in srgb, currentColor 16%, transparent);
    padding:.45rem .75rem;
    border-radius: 999px;
    font-size:.9rem;
    line-height:1;
    cursor:pointer;
    transition: background .12s ease, border-color .12s ease, color .12s ease, transform .06s ease;
  }
  .fbtn:hover { background: color-mix(in srgb, currentColor 12%, transparent); }
  .fbtn:active { transform: scale(.98); }

  .fbtn.is-active {
    background: color-mix(in srgb, var(--primary, currentColor) 15%, transparent);
    border-color: var(--primary, currentColor);
    color: var(--primary, currentColor);
  }
</style>


<script>
(function () {
  const cards = Array.from(document.querySelectorAll('#cards .card'));
  const btns  = Array.from(document.querySelectorAll('#filters .fbtn'));

  function setActive(btn) { btns.forEach(b => b.classList.toggle('is-active', b === btn)); }

  function apply(filter, btn) {
    setActive(btn);
    cards.forEach(c => {
      if (filter === '*') { c.style.display = ''; return; }
      const [kind, val] = filter.split(':');
      if (kind === 'cat') {
        c.style.display = (c.dataset.cats || '').split(' ').includes(val) ? '' : 'none';
      } else if (kind === 'tag') {
        c.style.display = (c.dataset.tags || '').split(' ').includes(val) ? '' : 'none';
      } else { c.style.display = ''; }
    });
  }

  btns.forEach(b => b.addEventListener('click', () => apply(b.dataset.filter, b)));
  const allBtn = btns.find(b => b.dataset.filter === '*');
  if (allBtn) { setActive(allBtn); }
})();
</script>
{{ end }}
